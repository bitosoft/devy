#!/usr/bin/env node

await (async () => {
  const { dirname } = await import("path");
  const { fileURLToPath } = await import("url");

  /**
   * Shim entry-point related paths.
   */
  if (typeof globalThis.__filename === "undefined") {
    globalThis.__filename = fileURLToPath(import.meta.url);
  }
  if (typeof globalThis.__dirname === "undefined") {
    globalThis.__dirname = dirname(globalThis.__filename);
  }
  /**
   * Shim require if needed.
   */
  if (typeof globalThis.require === "undefined") {
    const { default: module } = await import("module");
    globalThis.require = module.createRequire(import.meta.url);
  }
})();

var E=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,i)=>(typeof require<"u"?require:e)[i]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});import g from"fs/promises";import p from"path";import O from"os";import{execSync as Re}from"child_process";import{fileURLToPath as Ee}from"url";import N from"fs/promises";import A from"path";var B=class t{static MODEL_TYPE="NO_MODEL";constructor(e={}){this.HOME_DIR=process.env.HOME||process.env.USERPROFILE,this.DEVY_DIR=A.join(this.HOME_DIR,".devy"),this.LOG_FILE=A.join(this.DEVY_DIR,"logs.txt"),this.ERROR_LOG_FILE=A.join(this.DEVY_DIR,"error_logs.txt"),this.enableDebug=e.enableDebug||!1}getCaller(){let e=/(?:at\s+)?(?:file:\/\/\/)?(?:.*?\/)?([^\/\s]+\.js):(\d+)(?::\d+)?/,i=l=>{let h=l.match(e);return h?{filename:h[1],lineNumber:parseInt(h[2],10)}:null},s={};Error.captureStackTrace(s);let n=s.stack.split(`
`)[4],r=i(n);return r?`${r.filename}:${r.lineNumber}`:""}maybeLog(e,...i){if(!this.enableDebug)return;let n=[this.getCaller(),...i];this.appendLog(e,...n)}log(...e){this.maybeLog("Log",...e)}error(...e){this.maybeLog("Error",...e)}warn(...e){this.maybeLog("Warn",...e)}debug(...e){this.maybeLog("Debug",...e)}async appendLog(e,...i){let s=`${this.formatDate()},${t.MODEL_TYPE.padStart(8," ")},${e.padStart(8," ")}, ${JSON.stringify(i)}

`;e==="Error"?await N.appendFile(this.ERROR_LOG_FILE,s):await N.appendFile(this.LOG_FILE,s)}async logCommand(e,i){return this.appendLog("Command",JSON.stringify({command:e,output:i}))}async logPrompt(e,i){return t.MODEL_TYPE=i,this.appendLog("Prompt",e)}async logRequest(e){return this.appendLog("Request",JSON.stringify(e))}logResponse(e){return this.appendLog("Response",e)}formatDate(){let e=new Date,i=e.getDate().toString().padStart(2,"0"),s=(e.getMonth()+1).toString().padStart(2,"0"),n=e.getHours().toString().padStart(2,"0"),r=e.getMinutes().toString().padStart(2,"0");return`${i}/${s} ${n}:${r}`}};import q from"node:readline";import z from"node:readline";import Y from"fs";import D from"path";await(async()=>{let{dirname:t}=await import("path"),{fileURLToPath:e}=await import("url");if(typeof globalThis.__filename>"u"&&(globalThis.__filename=e(import.meta.url)),typeof globalThis.__dirname>"u"&&(globalThis.__dirname=t(globalThis.__filename)),typeof globalThis.require>"u"){let{default:i}=await import("module");globalThis.require=i.createRequire(import.meta.url)}})();var Q=Object.create,Z=Object.defineProperty,ee=Object.getOwnPropertyDescriptor,te=Object.getOwnPropertyNames,se=Object.getPrototypeOf,ie=Object.prototype.hasOwnProperty,j=(t=>typeof E<"u"?E:typeof Proxy<"u"?new Proxy(t,{get:(e,i)=>(typeof E<"u"?E:e)[i]}):t)(function(t){if(typeof E<"u")return E.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')}),V=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),re=(t,e,i,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of te(e))!ie.call(t,n)&&n!==i&&Z(t,n,{get:()=>e[n],enumerable:!(s=ee(e,n))||s.enumerable});return t},y=(t,e,i)=>(i=t!=null?Q(se(t)):{},re(e||!t||!t.__esModule?Z(i,"default",{value:t,enumerable:!0}):i,t)),ne=V((t,e)=>{"use strict";var i="\x1B",s=`${i}[`,n="\x07",r={to(a,o){return o?`${s}${o+1};${a+1}H`:`${s}${a+1}G`},move(a,o){let d="";return a<0?d+=`${s}${-a}D`:a>0&&(d+=`${s}${a}C`),o<0?d+=`${s}${-o}A`:o>0&&(d+=`${s}${o}B`),d},up:(a=1)=>`${s}${a}A`,down:(a=1)=>`${s}${a}B`,forward:(a=1)=>`${s}${a}C`,backward:(a=1)=>`${s}${a}D`,nextLine:(a=1)=>`${s}E`.repeat(a),prevLine:(a=1)=>`${s}F`.repeat(a),left:`${s}G`,hide:`${s}?25l`,show:`${s}?25h`,save:`${i}7`,restore:`${i}8`},l={up:(a=1)=>`${s}S`.repeat(a),down:(a=1)=>`${s}T`.repeat(a)},h={screen:`${s}2J`,up:(a=1)=>`${s}1J`.repeat(a),down:(a=1)=>`${s}J`.repeat(a),line:`${s}2K`,lineEnd:`${s}K`,lineStart:`${s}1K`,lines(a){let o="";for(let d=0;d<a;d++)o+=this.line+(d<a-1?r.up():"");return a&&(o+=r.left),o}};e.exports={cursor:r,scroll:l,erase:h,beep:n}}),R=V((t,e)=>{var i=process.argv||[],s=process.env,n=!("NO_COLOR"in s||i.includes("--no-color"))&&("FORCE_COLOR"in s||i.includes("--color")||process.platform==="win32"||j!=null&&j("tty").isatty(1)&&s.TERM!=="dumb"||"CI"in s),r=(a,o,d=a)=>w=>{let S=""+w,f=S.indexOf(o,a.length);return~f?a+l(S,o,d,f)+o:a+S+o},l=(a,o,d,w)=>{let S="",f=0;do S+=a.substring(f,w)+d,f=w+o.length,w=a.indexOf(o,f);while(~w);return S+a.substring(f)},h=(a=n)=>{let o=a?r:()=>String;return{isColorSupported:a,reset:o("\x1B[0m","\x1B[0m"),bold:o("\x1B[1m","\x1B[22m","\x1B[22m\x1B[1m"),dim:o("\x1B[2m","\x1B[22m","\x1B[22m\x1B[2m"),italic:o("\x1B[3m","\x1B[23m"),underline:o("\x1B[4m","\x1B[24m"),inverse:o("\x1B[7m","\x1B[27m"),hidden:o("\x1B[8m","\x1B[28m"),strikethrough:o("\x1B[9m","\x1B[29m"),black:o("\x1B[30m","\x1B[39m"),red:o("\x1B[31m","\x1B[39m"),green:o("\x1B[32m","\x1B[39m"),yellow:o("\x1B[33m","\x1B[39m"),blue:o("\x1B[34m","\x1B[39m"),magenta:o("\x1B[35m","\x1B[39m"),cyan:o("\x1B[36m","\x1B[39m"),white:o("\x1B[37m","\x1B[39m"),gray:o("\x1B[90m","\x1B[39m"),bgBlack:o("\x1B[40m","\x1B[49m"),bgRed:o("\x1B[41m","\x1B[49m"),bgGreen:o("\x1B[42m","\x1B[49m"),bgYellow:o("\x1B[43m","\x1B[49m"),bgBlue:o("\x1B[44m","\x1B[49m"),bgMagenta:o("\x1B[45m","\x1B[49m"),bgCyan:o("\x1B[46m","\x1B[49m"),bgWhite:o("\x1B[47m","\x1B[49m")}};e.exports=h(),e.exports.createColors=h}),C=y(ne(),1),b=y(R(),1);function ae(){if(process.platform!=="win32")return process.env.TERM!=="linux";let t=process.env;return!!(t.WT_SESSION||t.TERMINUS_SUBLIME||t.ConEmuTask==="{cmd::Cmder}"||t.TERM_PROGRAM==="Terminus-Sublime"||t.TERM_PROGRAM==="vscode"||t.TERM==="xterm-256color"||t.TERM==="alacritty"||t.TERMINAL_EMULATOR==="JetBrains-JediTerm")}function oe(){let t=["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))"].join("|");return new RegExp(t,"g")}var M=t=>t.replace(oe(),""),J=ae(),m=(t,e)=>J?t:e,le=J?["\u25D2","\u25D0","\u25D3","\u25D1"]:["\u2022","o","O","0"],he={pending:le.map(t=>b.default.magenta(t)),success:b.default.green(m("\u25C7","o")),error:b.default.red(m("\u25A0","x")),cancelled:b.default.yellow(m("\u25B2","x"))},c={INFO_STATUS:b.default.green(m("\u25C7","o")),ERROR_STATUS:b.default.red(m("\u25A0","x")),WARN_STATUS:b.default.yellow(m("\u25B2","x")),BAR_START:m("\u250C","T"),BAR:m("\u2502","|"),BAR_END:m("\u2514","\u2014"),BAR_H:m("\u2500","-"),CORNER_TOP_RIGHT:m("\u2510","+"),CONNECT_LEFT:m("\u251C","+"),CORNER_BOTTOM_RIGHT:m("\u2518","+")},ce=class{frame;message;statusSymbol;isHidden;taskSeparator;contentPadding;_status;statusChangeHandlers=[];_data;constructor(t,e="pending"){this.frame=0,this.message=t,this._status=e}get status(){return this._status}set status(t){this._status!==t&&(this._status=t,this.statusChangeHandlers.forEach(e=>e(t,this._data)))}setStatusWithData(t,e){this._data=e,this.status=t}onStatusChange(t){this.statusChangeHandlers.push(t)}},u=class T{static instance=null;static hasRenderedTitle=!1;tasks=[];spinners=new Map;interval=null;previousRenderedLines=0;isRunning=!1;taskPromises=[];isIdlePromise;resolveAllTasks=null;stream;rows;abortController;title;statusSymbols;keepAlive;defaultTaskSeparator;defaultContentPadding;taskPrefix;headerFormatter;isCursorHidden=!1;renderIntervalMs=80;constructor(e){this.stream=e.stream||process.stdout,this.title=e.title,this.rows=this.stream.rows||0,this.statusSymbols={...he,...e.customStatusSymbols},this.keepAlive=e.keepAlive||!1,this.defaultTaskSeparator=e.taskSeparator??c.BAR+`
`,this.defaultContentPadding=e.contentPadding??"  ",this.taskPrefix=e.taskPrefix??((i,s,n)=>`${i}${s}${n}`),this.headerFormatter=e.headerFormatter??(i=>i?`${c.BAR_START} ${b.default.inverse(i)}
`:""),this.stream.on("resize",()=>{this.rows=this.stream.rows||0}),e.renderIntervalMs&&(this.renderIntervalMs=e.renderIntervalMs),this.reset(),this.keepAlive&&this.run(new de)}static getInstance(e={}){return T.instance?e?.stopAndRecreate&&(T.instance.stop(),T.instance=new T(e)):T.instance=new T(e),T.instance}reset(){this.tasks=[],this.spinners=new Map,this.taskPromises=[],this.previousRenderedLines=0,this.abortController=new AbortController,this.isIdlePromise=new Promise(e=>{this.resolveAllTasks=e})}idle(){return this.isIdlePromise}startRendering(){this.isRunning=!0,this.render(),this.interval=setInterval(()=>this.render(),this.renderIntervalMs),process.once("SIGINT",()=>{this.stop()})}stop(){this.isRunning&&(this.cancelPendingTasks(),this.render(),this.stopRendering(),this.reset())}stopRendering(){this.interval&&(clearInterval(this.interval),this.interval=null),this.isRunning=!1,this.showCursor(),this.stream.write(`
`)}hideCursor(){this.isCursorHidden||(this.stream.write(C.cursor.hide),this.isCursorHidden=!0)}showCursor(){this.isCursorHidden&&(this.stream.write(C.cursor.show),this.isCursorHidden=!1)}cancelPendingTasks(){this.spinners.forEach(e=>{e.status==="pending"&&(e.status="cancelled",e.message+=" (Cancelled)")}),this.abortController.abort()}update(e,i){let s=this.spinners.get(e);s&&(s.message=i)}run(...e){this.isRunning||this.reset();let i=[];return e.forEach(s=>{if(s.disabled)return;let n=s.index??this.spinners.size,r=new ce(s.initialMessage);r.statusSymbol=s.statusSymbol,r.isHidden=s.isHidden,r.contentPadding=s.contentPadding??this.defaultContentPadding,r.taskSeparator=s.taskSeparator??this.defaultTaskSeparator,this.spinners.set(n,r),this.tasks.push(s),i.push(n),this.taskPromises.push(this.executeTask(s,n))}),this.isRunning||this.startRendering(),i}onStatusChange(e,i){let s=this.spinners.get(e);s&&s.onStatusChange(i)}hasPendingTasks(){return Array.from(this.spinners.values()).some(e=>e.status==="pending")}async executeTask(e,i){let s=r=>{this.update(i,r)},n=this.spinners.get(i);if(n){try{let r=await e.task(s,this.abortController.signal);if(this.abortController.signal.aborted)return;r&&typeof r=="object"&&"task"in r&&this.run(r),n.setStatusWithData("success",r)}catch(r){n.setStatusWithData("error",r)}this.hasPendingTasks()||(this.resolveAllTasks?.(),this.stop(),T.hasRenderedTitle=!0)}}render(){if(!this.isRunning)return;this.hideCursor();let e=Array.from(this.spinners.entries()).filter(([n,r])=>!r.isHidden).sort(([n],[r])=>n-r),i=(T.hasRenderedTitle?"":this.headerFormatter(this.title))+e.map(([n,r])=>{let l=this.getStatusSymbol(r),h=r.contentPadding??this.defaultContentPadding;return`${this.taskPrefix(r.taskSeparator,l,h)}${r.message}`}).join(`
`);this.previousRenderedLines>0&&this.stream.write(C.erase.lines(this.previousRenderedLines)),this.stream.write(C.cursor.to(0,0));let s=i.split(`
`).length;s<=this.rows?this.stream.write(i):this.stream.write(i.split(`
`).slice(s-this.rows).join(`
`)),this.previousRenderedLines=s}getStatusSymbol(e){if(typeof e.statusSymbol=="string")return e.statusSymbol;if(e.status==="pending"){let i=this.statusSymbols.pending;return Array.isArray(i)?(e.frame=(e.frame+1)%i.length,i[e.frame]):i}else return this.statusSymbols[e.status]}},k=class{initialMessage;updateFn=()=>{};signal;close=()=>{};fail=()=>{};constructor(t=""){this.initialMessage=t}initialize(){}beforeClose(t){}task=async(t,e)=>{if(this.updateFn=t,this.signal=e,this.initialize(),e?.aborted)return;let i=()=>{this.close()};e.addEventListener("abort",i,{once:!0});try{return await new Promise((s,n)=>{if(e.aborted){s();return}this.close=r=>{this.beforeClose(r),s(r)},this.fail=n})}finally{e.removeEventListener("abort",i)}}},de=class extends k{isHidden=!0},ue=(t,e)=>{u.getInstance().run({statusSymbol:e,initialMessage:t,task:async()=>{}})};var L=y(R(),1),me=class{tag="";enableDebug=!1;constructor({tag:t="",enableDebug:e=!1}={}){this.tag=t,this.enableDebug=e}_log(t,e){ue(e,t)}debug(...t){if(!this.enableDebug)return;let e=[`[${this.getCaller()}] `,...t];this._log(c.INFO_STATUS,L.default.magenta(e.join("")))}log(...t){this.enableDebug&&this._log(c.INFO_STATUS,t.join(" "))}error(...t){this._log(c.ERROR_STATUS,L.default.red(t.join(" ")))}warn(...t){this._log(c.WARN_STATUS,L.default.yellow(t.join(" ")))}info(...t){this._log(c.INFO_STATUS,L.default.blue(t.join(" ")))}getCaller(){let t=/(?:at\s+)?(?:file:\/\/\/)?(?:.*?\/)?([^\/\s]+\.js):(\d+)(?::\d+)?/,e=r=>{let l=r.match(t);return l?{filename:l[1],lineNumber:parseInt(l[2],10)}:null},i={};Error.captureStackTrace(i);let s=i.stack.split(`
`)[4],n=e(s);return n?`${n.filename}:${n.lineNumber}`:""}},P=y(R(),1),U=class extends k{rawText="";initialMessage="";activeLine=!1;hooks=new Map;processedSequences=new Map;contentPadding="  ";addHook(t){this.hooks.set(t.startSequence,t)}processHooks(t){let e=t;for(let[i,s]of this.hooks.entries()){let n=e.indexOf(s.startSequence);for(;n!==-1;){let r=e.indexOf(s.endSequence,n+s.startSequence.length);if(r===-1){let l=e.slice(n+s.startSequence.length),h=s.callback("chunk",l);e=e.slice(0,n)+h}else{let l=e.slice(n+s.startSequence.length,r),h=`${n}-${r}-${s.startSequence}-${s.endSequence}`,a;this.processedSequences.has(h)?a=this.processedSequences.get(h):(a=s.callback("end",l),this.processedSequences.set(h,a)),e=e.slice(0,n)+a+e.slice(r+s.endSequence.length)}n=e.indexOf(s.startSequence,n+s.startSequence.length)}}return e}stream(t){this.rawText+=(this.activeLine?`

`:"")+t,this.activeLine=!1;let e=Math.min(process.stdout.columns??80,50),i=`
`+this.processHooks(this.rawText)+`
`;this.updateFn(this.multiLineFormat(i,e))}streamln(t){this.rawText?this.stream(`
`+t):this.stream(t),this.activeLine=!0}multiLineFormat(t,e=process.stdout.columns,i="reset"){let[s,...n]=this.getLines(t,e);return P.default[i](s)+(n.length>0?`
`+n.map(r=>`${P.default.reset(c.BAR)}${this.contentPadding}${P.default[i](r)}`).join(`
`):"")}getLines(t,e){let i=t.split(`
`),s=[];for(let n of i){if(n.length<=e){s.push(n);continue}let r=n;for(;r.length>e;){let l=r.lastIndexOf(" ",e);l===-1&&(l=e),s.push(r.slice(0,l).trim()),r=r.slice(l).trim()}r.length>0&&s.push(r)}return s}smartLineBreak(t,e=120){if(!t||typeof t!="string")return t;let i=/[.!?]\s/g,s=/[,;:]\s/g,n=t.split(`
`),r="";for(let l=0;l<n.length;l++){let h=n[l].split(/\s+/),a="";for(let o=0;o<h.length;o++){let d=h[o],w=a?`${a} ${d}`:d;if(w.length<=e-5)a=w;else{let S=a.match(i),f=a.match(s),x=-1;if(S){let I=a.lastIndexOf(S[S.length-1]);I>=e/2&&(x=I)}if(x===-1&&f){let I=a.lastIndexOf(f[f.length-1]);I>=e*3/4&&(x=I)}x!==-1?(r+=`${a.slice(0,x+2)}
`,a=a.slice(x+2)+` ${d}`):(r+=`${a}
`,a=d)}}a&&(r+=a),l<n.length-1&&(r+=`
`)}return r}},F=y(R(),1),ge=(t,e)=>{let i=`
${t}`.split(`
`);e||(e="");let s=M(e).length,n=Math.max(20,s)+5,r=i.join(`
`),l=`${F.default.reset(e)}${F.default.gray(c.BAR_H.repeat(Math.max(n-s-1,1)))}
${r}
${F.default.gray(c.BAR_START+c.BAR_H.repeat(n-1))}`;return{initialMessage:"",statusSymbol:c.BAR_END,contentPadding:"",task:async(h,a)=>{h(l)}}},v=y(R(),1),pe=class extends k{constructor(t,e=" Yes ",i=" No ",s=!1){super(),this.prompt=t,this.confirmText=e,this.declineText=i,this.hasDeclined=s}isFinalized=!1;isCancelled=!1;rl;initialize(){q.emitKeypressEvents(process.stdin),process.stdin.isTTY&&process.stdin.setRawMode(!0),this.rl=q.createInterface(process.stdin),process.stdin.on("keypress",this.keyPressHandler),this.signal?.addEventListener("abort",()=>{this.rl.close(),this.close(!1)}),this.updateUI()}keyPressHandler=(t,e)=>{e?.name==="return"?this.finalize():e?.name==="y"?(this.hasDeclined=!1,this.finalize()):e?.name==="n"?(this.hasDeclined=!0,this.finalize()):e?.name==="tab"?(this.hasDeclined=!this.hasDeclined,this.updateUI()):e?.name==="left"?(this.hasDeclined=!1,this.updateUI()):e?.name==="right"?(this.hasDeclined=!0,this.updateUI()):(e?.name==="c"||e?.name==="d")&&e.ctrl&&(this.isCancelled=!0,this.rl.close(),this.updateUI(),this.close("Aborted"))};finalize(){this.isFinalized=!0,process.stdin.removeListener("keypress",this.keyPressHandler),process.stdin.setRawMode(!1),this.rl.close(),this.updateUI(),this.close(!this.hasDeclined)}updateUI(){let t=this.hasDeclined?this.confirmText+" / "+v.default.bgRed(this.declineText):v.default.bgGreen(this.confirmText)+" / "+this.declineText,e=this.hasDeclined?v.default.bgRed(this.declineText):v.default.bgGreen(this.confirmText),i=v.default.inverse(" cancelled "),s=this.isCancelled?i:this.isFinalized?e:t;this.updateFn(`${this.prompt}
${c.BAR}  ${s}`)}},$=y(R(),1),fe=(t,e)=>{let i=`
${t}
`.split(`
`),s=M(e).length,n=Math.max(i.reduce((h,a)=>(a=M(a),a.length>h?a.length:h),0),s)+2,r=i.map(h=>`${$.default.gray(c.BAR)}  ${$.default.dim(h)}${" ".repeat(n-M(h).length)}${$.default.gray(c.BAR)}`).join(`
`),l=`${$.default.reset(e)} ${$.default.gray(c.BAR_H.repeat(Math.max(n-s-1,1))+c.CORNER_TOP_RIGHT)}
${r}
${$.default.gray(c.CONNECT_LEFT+c.BAR_H.repeat(n+2)+c.CORNER_BOTTOM_RIGHT)}`;return{initialMessage:"",task:async(h,a)=>{h(l)}}},Se=class extends k{index=1100;unit="s";message="Elapsed ";startTime;interval;constructor(){super()}beforeClose(){this.interval&&clearInterval(this.interval)}initialize(){this.startTime=process.hrtime(),this.interval=setInterval(()=>{let[t,e]=process.hrtime(this.startTime),i=t+e/1e9;this.updateFn(`${this.message}${i.toFixed(1)}${this.unit}`),this.signal?.aborted&&(clearInterval(this.interval),this.close())},100)}setMessage(t){this.message=t}};var _=y(R(),1),Te=class extends k{constructor(t,e){super(),this.prompt=t,this.placeholder=e}rl;line;isFinalized=!1;initialize(){z.emitKeypressEvents(process.stdin),process.stdin.isTTY&&process.stdin.setRawMode(!0),this.rl=z.createInterface(process.stdin,null,void 0,!0),process.stdin.on("keypress",()=>this.updateUI()),this.rl.on("line",this.onEnter),this.rl.on("SIGINT",()=>{this.isFinalized=!0,this.line=_.default.gray("<cancelled>"),this.rl.close(),this.close("Aborted")}),this.updateUI()}onEnter=t=>{this.line=t,this.isFinalized=!0,this.rl.close(),this.close(t)};updateUI(){this.isFinalized||(this.line=this.rl.line),this.line||(this.line=_.default.gray(this.placeholder)),this.updateFn(`${this.prompt}
${c.BAR}
${c.BAR}  ${this.multiLineFormat(this.line)}${this.isFinalized?"":`
`+c.CONNECT_LEFT+c.BAR_H}`)}multiLineFormat(t,e=process.stdout.columns-10,i="reset"){let[s,...n]=this.getLines(t,e);return _.default[i](s)+(n.length>0?`
`+n.map(r=>`${_.default.reset(c.BAR)}  ${_.default[i](r)}`).join(`
`):"")}getLines(t,e){let i=t.split(`
`),s=[];for(let n of i){if(n=n.trim(),n.length<=e){s.push(n);continue}let r=n;for(;r.length>e;){let l=r.lastIndexOf(" ",e);l===-1&&(l=e),s.push(r.slice(0,l).trim()),r=r.slice(l).trim()}r.length>0&&s.push(r)}return s}},G=y(R(),1);function W(t){let e=t.split(D.sep),i=e.pop(),s=e.pop();return s?`${e.length>0?"..."+D.sep:""}${s}${D.sep}${i}`:i}var ye={startSequence:"```",endSequence:"```",extractPathAndContent(t){let e=t.split(`
`);if(e.length<2)return{path:null,content:t,writeFile:!1,language:""};let i=e[0].trim().replace("```",""),s=e[1].trim(),n=[{start:"//",end:""},{start:"<!--",end:"-->"},{start:"/*",end:"*/"},{start:"#",end:""}],r=null,l=!1,h=t,a=n.find(o=>s.startsWith(o.start)&&(o.end===""||s.endsWith(o.end)));if(a){let o=s.replace(a.start,"").replace(a.end,"").trim().match(/(.*?)(:W)?$/);o&&(r=o[1].trim(),l=o[2]===":W",h=e.slice(2).join(`
`))}else h=e.slice(1).join(`
`);return{path:r,content:h,writeFile:l,language:i}},getLastNLines(t,e){return t.split(`
`).slice(-e).join(`
`)},callback(t,e){if(!e)return"";let{path:i,content:s,writeFile:n,language:r}=this.extractPathAndContent(e),l=n?G.default.bgRed:G.default.bgBlue,h=Math.min(8,process.stdout.rows-10);if(h<2&&(h=2),t==="chunk"){let a=this.getLastNLines(s,h),o=W(i||r||"");return`==== ${l(` ${o} `)}
${a}
====
`}else if(t==="end"){if(n&&i)try{let d=D.dirname(i);Y.mkdirSync(d,{recursive:!0}),Y.writeFileSync(i,s),console.log(`File saved: ${i}`)}catch(d){console.error(`Error saving file: ${d}`)}let a=this.getLastNLines(s,h),o=W(i||r||"");return`==== ${l(` ${o} `)}
${a}
====
`}return""}},we=class{logger;streamTask;confirmationPrompt;stopwatch;hasStreamingTask=!1;hasStopwatchTask=!1;constructor(t){this.logger=new me({enableDebug:t?.enableDebug})}log(...t){this.logger.log(...t)}debug(...t){this.logger.debug(...t)}info(...t){this.logger.info(...t)}warn(...t){this.logger.warn(...t)}error(...t){this.logger.error(...t)}stream(t){this.hasStreamingTask||(this.streamTask=new U,this.streamTask.addHook(ye),u.getInstance().run(this.streamTask),this.hasStreamingTask=!0),this.streamTask.stream(t)}streamln(t){this.hasStreamingTask||(this.streamTask=new U,u.getInstance().run(this.streamTask),this.hasStreamingTask=!0),this.streamTask.streamln(t)}endStream(){this.streamTask&&this.streamTask.close(),this.hasStreamingTask=!1}streamOrLog(t){this.hasStreamingTask?this.stream(t):this.log(t)}code(t,e){u.getInstance().run(ge(t,e))}stop(){u.getInstance().stop()}idle(){return u.getInstance().idle()}confirm(t){this.confirmationPrompt=new pe(t);let[e,i]=u.getInstance().run(this.confirmationPrompt);return new Promise((s,n)=>{u.getInstance().onStatusChange(e,(r,l)=>{typeof l=="boolean"&&s(l),s(!1)})})}prompt(t){let e=new Te(t),[i,s]=u.getInstance().run(e);return new Promise((n,r)=>{u.getInstance().onStatusChange(i,(l,h)=>{n(h)})})}note(t,e){u.getInstance().run(fe(t,e))}status(t){this.hasStopwatchTask||(this.stopwatch=new Se,u.getInstance().run(this.stopwatch),this.hasStopwatchTask=!0),this.stopwatch.setMessage(t)}endStatus(t){let e=t instanceof Error?t.message:t;t&&(this.stopwatch.setMessage(e),this.stopwatch.updateFn(e)),t instanceof Error?this.stopwatch.fail(e):this.stopwatch.close(e),this.hasStopwatchTask=!1}assert(t,e,...i){throw new Error("Method not implemented.")}clear(){throw new Error("Method not implemented.")}count(t){throw new Error("Method not implemented.")}countReset(t){throw new Error("Method not implemented.")}dir(t,e){throw new Error("Method not implemented.")}dirxml(...t){throw new Error("Method not implemented.")}group(...t){throw new Error("Method not implemented.")}groupCollapsed(...t){throw new Error("Method not implemented.")}groupEnd(){throw new Error("Method not implemented.")}table(t,e){throw new Error("Method not implemented.")}time(t){throw new Error("Method not implemented.")}timeEnd(t){throw new Error("Method not implemented.")}timeLog(t,...e){throw new Error("Method not implemented.")}timeStamp(t){throw new Error("Method not implemented.")}trace(t,...e){throw new Error("Method not implemented.")}Console;profile(t){throw new Error("Method not implemented.")}profileEnd(t){throw new Error("Method not implemented.")}};var be=null;function K(t){be=u.getInstance(t),global.console=new we(t)}var De=y(R(),1);var Oe=b.default;var xe=Ee(import.meta.url),X=p.dirname(xe),H=class{constructor(){this.DEVY_DIR=p.join(O.homedir(),".devy"),this.SHELL_SCRIPTS_DIR=p.join(X,"shell"),this.ASSETS_DIR=p.join(X,"assets"),this.SUPPORTED_SHELLS=["bash","zsh"],this.flogger=new B}async run(){try{K({title:" Devy ",enableDebug:!1,keepAlive:!1}),await this.createDevyDirectory(),await this.copyDefaultConfig(),await this.setupShells(),await this.enableHistoryLogging(),await this.printPostInstallMessage(),console.log("Start a new shell session to see Devy in action!")}catch(e){console.error("Error during post-installation setup:",e)}}async createDevyDirectory(){await g.mkdir(this.DEVY_DIR,{recursive:!0})}async copyDefaultConfig(){try{await g.access(p.join(this.DEVY_DIR,"config.yaml"),g.constants.R_OK)}catch{await g.copyFile(p.join(this.ASSETS_DIR,"default-config.yaml"),p.join(this.DEVY_DIR,"config.yaml"))}}async setupShells(){for(let e of this.SUPPORTED_SHELLS)this.isShellAvailable(e)&&await this.setupShellConfig(e)}isShellAvailable(e){try{return Re(`which ${e}`),!0}catch{return!1}}async setupShellConfig(e){let i=this.getRCFile(e);try{await g.access(i,g.constants.F_OK)}catch{await g.writeFile(i,"",{flag:"wx"})}let s=p.join(this.SHELL_SCRIPTS_DIR,`${e}.sh`),n=`[[ -f "${s}" ]] && builtin source "${s}"`,r=new RegExp(`^.*source.*devy[\\\\/]dist[\\\\/]shell[\\\\/]${e}\\.sh.*$`,"gm");try{let l=await g.readFile(i,"utf-8");r.test(l)?l=l.replace(r,n):l+=`
# Devy's hook into the shell. Remove to disable Devy.
${n}`,await g.writeFile(i,l)}catch(l){console.error(`Error updating ${i}:`,l)}}getRCFile(e){switch(e){case"bash":return p.join(O.homedir(),".bashrc");case"zsh":return p.join(O.homedir(),".zshrc");case"fish":return p.join(O.homedir(),".config","fish","config.fish");default:throw new Error(`Unsupported shell: ${e}`)}}async printPostInstallMessage(){try{let e=await g.readFile(p.join(this.ASSETS_DIR,"devy-ascii.txt"),"utf-8");console.log(e)}catch(e){console.error("Error printing post-install message:",e)}}async enableHistoryLogging(){for(let e of this.SUPPORTED_SHELLS)this.isShellAvailable(e)&&await this.enableHistoryLoggingForShell(e)}async enableHistoryLoggingForShell(e){let i=this.getRCFile(e),s=await g.readFile(i,"utf-8");switch(e){case"bash":s=this.enableBashHistoryLogging(s);break;case"zsh":s=this.enableZshHistoryLogging(s);break;case"fish":s=this.enableFishHistoryLogging(s);break}await g.writeFile(i,s)}enableBashHistoryLogging(e){return e.includes("HISTTIMEFORMAT")||(e+=`
# Devy: Enhanced Bash History Settings
HISTSIZE=10000
HISTFILESIZE=20000
HISTCONTROL=ignoreboth:erasedups
HISTTIMEFORMAT="%F %T "
shopt -s histappend
PROMPT_COMMAND="history -a; history -c; history -r; $PROMPT_COMMAND"
`),e}enableZshHistoryLogging(e){return e.includes("EXTENDED_HISTORY")||(e+=`
# Devy: Enhanced Zsh History Settings
HISTFILE=~/.zsh_history
HISTSIZE=10000
SAVEHIST=10000
setopt EXTENDED_HISTORY
setopt HIST_EXPIRE_DUPS_FIRST
setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_SPACE
setopt HIST_VERIFY
setopt INC_APPEND_HISTORY
setopt SHARE_HISTORY
`),e}enableFishHistoryLogging(e){return e.includes("fish_history devy_history")||(e+=`
# Devy: Enhanced Fish History Settings
set -g fish_history devy_history
set -g history_max_lines "10000"
`),e}},$e=new H;$e.run();
